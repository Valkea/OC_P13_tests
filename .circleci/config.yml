version: 2.1

orbs:
        python: circleci/python@1.3.2
        docker: circleci/docker@1.5.0

jobs:

        build-and-test:
                executor: python/default
                working_directory: /home/circleci/project
                steps:
                        - checkout:
                                path: /home/circleci/project
                        - python/install-packages:
                                pip-dependency-file: requirements.txt
                                pkg-manager: pip
                        - run:
                                command: pytest
                                name: pytest
                        - run:
                                command: flake8
                                name: flake8

        build-and-push:
                machine: true
                working_directory: /home/circleci/project
                steps:
                        - checkout:
                                path: /home/circleci/project
                        - run:
                                name: Build and push Docker image
                                command: |
                                        docker build -t ${PROJECT_REPONAME} .

                        - run:
                                name: push Docker image to Heroku
                                command: |
                                        docker login -u ${HEROKU_USERNAME} -p ${HEROKU_TOKEN} registry.heroku.com

                                        docker tag ${PROJECT_REPONAME}:latest registry.heroku.com/${HEROKU_APP_NAME}/web
                                        docker push registry.heroku.com/${HEROKU_APP_NAME}/web

                                        docker logout registry.heroku.com
                        - run:
                                name: push Docker image to Docker-Hub
                                command: |
                                        echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_LOGIN} --password-stdin

                                        docker tag ${PROJECT_REPONAME}:latest ${DOCKER_LOGIN}/${PROJECT_REPONAME}:latest
                                        docker tag ${PROJECT_REPONAME}:latest ${DOCKER_LOGIN}/${PROJECT_REPONAME}:${CIRCLE_SHA1}
                                        docker push ${DOCKER_LOGIN}/${PROJECT_REPONAME}

                                        docker logout
workflows:
        main:
                jobs:
                        - build-and-test
                        - build-and-push:
                                requires:
                                        - build-and-test
                                filters:
                                        branches:
                                                only: master
